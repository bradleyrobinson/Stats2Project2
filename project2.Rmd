---
title: "Final Project"
author: "Samira Zarandioon and Bradley Robinson"
date: "8/10/2018"
output: pdf_document
---

## Introduction

This data analysis report is based on a data set that is collected by the Global Longitudinal Study of Osteoporosis in Women (GLOW). According the official website of the research team (http://www.outcomes-umassmed.org/glow/), the goal of this research was to improve understanding of the risk and prevention of osteoporosis-related fractures among female residents of 10 countries who were 55 years of age and older. GLOW enrolled over 60,000 women through over 700 physicians in 10 countries, and conducted annual follow-up for up to 5 years through annual patient questionnaires. 

## Data Description

The dataset used in this analysis is called GLOW500, which contains 500 observations from six sites in the united states. The target (outcome/response) variable FRACTURE indicates whether the subject had any fracture in the first year of followup. It includes 13 selected potential risk factors for fracture. According to the source of data, given the fact that fracture rate was only 4% these 500 observations are over sampled from 21,000 original observation. 

Description of each field in the data set is as follows:

Explanatory Variables:

```
SUB_ID: Id code for each subject (Categorical)
SITE_ID: Id code for the study site (Categorical)
PHY_ID: Id code for the Physician (Categorical)
PRIORFRAC: Does the subject have history of prior fracture? (1 => Yes, 0 => No) (Bineary)
AGE: Age at enrolment (Numeric)
WEIGHT: Weight at enrollment (Numeric)
HEIGHT: Height at enrollment (Numeric)
BMI: Body mass index (Numeric)
PREMENO: Did the subjet had Menopause before age 45? (1 => Yes, 0 => No) (Bineary)
MOMFRAC: Has subject's mother ever had hip fracture? (1 => Yes, 0 => No) (Bineary)
ARMASSIST: Does the subject need arms to stand form a chare? (1 => Yes, 0 => No) (Bineary)
SMOKE: Is the subject a Smoker? (1 => Yes, 0 => No) (Bineary)
RATERISK: Subject's self-reported risk of fractur (1 => Less than others of the same age, 2 => Same as others of the same age, 3 => Greater than others of the same age) (Categorical)
FRACSCORE: Fracture risk score (Computed based on AGE, WEIGHT, ARMASSIST, SMOKE, MOMFRAC, PRIORFRAC)  (Neumeric)

Response Variable:

FRACTURE: Did subject have any fracture in first year? (1 => Yes, 0 => No) (Bineary)
```

A summary a of dataset that illustrates distribution of each filed is presented below:

```{r, echo=FALSE}
glow500 <- read.csv(file="glow500.csv",head=TRUE,sep=",")
summary(glow500)
```

## Exploratory Analysis

The following graphical representation of correlations between the fields of glow500 datasets, gives us a very good understanding of how the explanatory variables are related to each other and the response variable. For example, it shows high correlation of PHY_ID and SITE_ID. It also shows that BMI is highly correlated to WEIGHT, which is driven by the definition of the BMI. Moreover, it shows that FRACSCORE is highly correlated with AGE, PRIORFRAC, ..., which are used to compute the risk. Correlated variables indicate some level of redundancy in the explanatory variables.

Correlation of explanatory variables with the target variable FRACTURE is quite informative. The plot depicts that PRIORFRAC, AGE, ARMASSIST, and MOMFRAC have relatively high positive correlation to the target variable. However, HEIGHT has negative correlation to the target variable.

```{r, echo=FALSE}
# The following code illustrates the correlation matrix of the glov500 dataset
#install.packages("corrplot")
library(corrplot)
glow500_corr <- cor(glow500)
corrplot.mixed(glow500_corr, tl.pos="lt")
```

Performing Principal Component Analysis (PCA), against the numeric explanatory variables also gives us some insight on redundancy and importance of explanatory variables. As the following Scree Plot illustrates only three components can explain over 99% of variance, which indicates some redundancy in these variables that can be justified due to correlation between these variables.


![Principal Component Analysis On Numerical Fields](pca_numeric.png)



## Addressing Objective 1:

We used step-wise parameter selection method for training a logistic regression model which produced the following model:

![](logistic_regression_stepwise.png)

The corresponding regression formula is as follows:

Logit(Probability of Fracture) = log(Odds Ratio of Fracture) = log( Probability of Fracture/ (1-Probability of Fracture)) = 3.2477 - 0.0378 * HEIGHT + 0.4072 * RATERISK + 0.2244 * FRACSCORE

In other words:

Probability of Fracture = Softmax(3.2477 - 0.0378 * HEIGHT + 0.4072 * RATERISK + 0.2244 * FRACSCORE)

The negative coefficient of HEIGHT is consistent with negative correlation that was illustrated by a pink circle in the correlation matrix in the previous section.

The following tables shows how these three variables are selected and their corresponding p-value for selection.
![](step_wise.png)

Effect of each variable on the odds ratio (point estimate and 95% confidence interval) is presented in the following table:
![](odds_ratio.png)


## Model Selection Required

### Type of Selection
			Any or all:  	, RIDGE, ELASTIC NET,
			Step-wise, Forward, Backward 
			Manual / Intuition		

###		Checking Assumptions Required
                                        Lack of fit test
                                        Influential point analysis (Cookâ€™s D and Leverage)
			Optional  Residual Plots
			
###	Parameter Interpretation
		Interpretation  Required
		Confidence Intervals Required
	
### Final conclusions from the analyses of Objective 1 Required

## Addressing Objective 2
Make sure it is clear how many models were created to compete against the one in Objective 1.  Make note of any tuning parameters that were used and how you came up with them (knn and random forest logistics)  Required

Main Analysis Content Required
	Overall report of the error metrics on a test set or CV run.  Also if the two best models have error rates of .05 and .045,  can we really say that one model is outperforming the other?  What other tools that we learned in the second half of this class that could help us get at that?

## Conclusion/Discussion Required
		The conclusion should reprise the questions and conclusions of objective 2 with recommendations of the final model, what could be done to help analysis and model building in the future, and any insight as to why one method outshined all the rest if that is indeed the case.  If they all are similar why did you go with your final model?

## Appendix Required
	Well commented SAS/R Code Required
 	Graphics and summary tables (Can be placed in the appendix or in the written report itself.)

## References
* Section 1.6.3: https://ia800206.us.archive.org/7/items/WileySeriesInProbabilityAndStatisticsDavidW.HosmerStanleyLemeshowRodneyX.Sturdiv/(Wiley%20Series%20in%20Probability%20and%20Statistics)%20David%20W.%20Hosmer,%20Stanley%20Lemeshow,%20Rodney%20X.%20Sturdivant%20(auth.),%20Walter%20A.%20Shewhart,%20Samuel%20S.%20Wilks%20(eds.)-Applied%20Logistic%20Regression-Wiley%20(2013).pdf
* 

```{r}
library(MASS)       # provides LDA & QDA model functions


glow500 <- read.csv(file="glow500.csv",head=TRUE,sep=",")

set.seed(123)
sample <- sample(c(TRUE, FALSE), nrow(glow500), replace = T, prob = c(0.6,0.4))
train <- glow500[sample, ]
test <- glow500[!sample, ]

(lda.m1 <- lda(FRACTURE ~ RATERISK + FRACSCORE + HEIGHT, data = train))
```

```{r}
pairs(glow500)
```

```{r}
#The cor() function produces a matrix that contains all of the pairwise correlations among the predictors in a data set. 
cor(glow500)
```

Train randomforest:

```{r}
library(randomForest)
train$FRACTURE_F <- as.factor(train$FRACTURE)
rf.m <- randomForest(FRACTURE_F ~ RATERISK + FRACSCORE + HEIGHT, data=train, maxnodes=4, ntree=30)
test.predicted.rf <- predict(rf.m, newdata = test, type="response")

```

Linear Discriminant Analysis

```{r}
(lda.m1 <- lda(FRACTURE ~ RATERISK + FRACSCORE + HEIGHT, data = train))
```

```{r}
plot(lda.m1)
```

```{r}
(qda.m1 <- qda(FRACTURE ~ RATERISK + FRACSCORE + HEIGHT, data = train))
```

Train linear regression model:

```{r}
(glm.fit <- glm(FRACTURE ~ RATERISK + FRACSCORE + HEIGHT, data = train))
```

Evaluate random forest:

```{r}

library(randomForest)
train$FRACTURE <- as.factor(train$FRACTURE)
rf.m <- randomForest(FRACTURE ~ RATERISK + FRACSCORE + HEIGHT, data=train, maxnodes=5, ntree=5)
test.predicted.rf <- predict(rf.m, newdata = test, type="response")

test.predicted.rf <- predict(rf.m, newdata = test, type="response")
# confusion matrix
table(test$FRACTURE, test.predicted.rf)
# accuracy rate
mean(test.predicted.rf == test$FRACTURE)
```

Evaluate Linear Discriminant Analysis Model:

```{r}
# predictions
test.predicted.lda <- predict(lda.m1, newdata = test)

# confusion matrix
table(test$FRACTURE, test.predicted.lda$class)
# accuracy rate
mean(test.predicted.lda$class == test$FRACTURE)

```


```{r}
# predictions
test.predicted.qda <- predict(qda.m1, newdata = test)

# confusion matrix
table(test$FRACTURE, test.predicted.qda$class)

# accuracy rate
mean(test.predicted.qda$class == test$FRACTURE)
```

Evaluate Linear Regression Model:

Confusion Matrix:
```{r}
# predictions
glm.probs <- predict(glm.fit, test, type = "response")

# confusion matrix
table(test$FRACTURE, ifelse(glm.probs < 0.5, 0, 1))
```

Accuracy:
```{r}
# accuracy rate
mean(ifelse(glm.probs > 0.5, 1 , 0) == test$FRACTURE)
```



```{r}
# ROC curves
library(ROCR)
library(dplyr)

library(randomForest)
train$FRACTURE <- as.factor(train$FRACTURE)
rf.m <- randomForest(FRACTURE ~ RATERISK + FRACSCORE + HEIGHT, data=train, maxnodes=5, ntree= 1000)
test.predicted.rf <- predict(rf.m, newdata = test, type="response")


logistic <- prediction(glm.probs, test$FRACTURE) %>%
  performance(measure = "tpr", x.measure = "fpr")

lda <- prediction(test.predicted.lda$posterior[,2], test$FRACTURE) %>%
  performance(measure = "tpr", x.measure = "fpr")

qda <- prediction(test.predicted.qda$posterior[,2], test$FRACTURE) %>%
  performance(measure = "tpr", x.measure = "fpr")

test.predicted.rf.prob <- predict(rf.m, newdata = test, type="prob")
rf <- prediction(test.predicted.rf.prob[,2], test$FRACTURE) %>%
  performance(measure = "tpr", x.measure = "fpr")

plot(logistic, col = "red")
plot(lda, add = TRUE, col = "blue")
plot(qda, add = TRUE, col = "green")
plot(rf, add = TRUE, col = "yellow")

```

```{r}
# Logistic regression AUC
prediction(glm.probs, test$FRACTURE) %>%
  performance(measure = "auc") %>%
  .@y.values

# LDA AUC
prediction(test.predicted.lda$posterior[,2], test$FRACTURE) %>%
  performance(measure = "auc") %>%
  .@y.values

# QDA AUC
prediction(test.predicted.qda$posterior[,2], test$FRACTURE) %>%
  performance(measure = "auc") %>%
  .@y.values

# RandomForest AUC
prediction(test.predicted.rf.prob[,2], test$FRACTURE) %>%
  performance(measure = "auc") %>%
  .@y.values

```




SAS Codes:


```
LIBNAME MYSASLIB '/home/szarandioon0/';
DATA GLOW500_ORIG;
INFILE '/home/szarandioon0/statistics2/Project2/glow500.csv' DLM = ',' FIRSTOBS = 2;
INPUT SUB_ID SITE_ID PHY_ID	PRIORFRAC AGE WEIGHT HEIGHT BMI PREMENO MOMFRAC ARMASSIST SMOKE RATERISK FRACSCORE FRACTURE;
RUN;

DATA GLOW500(DROP = SUB_ID); 
SET GLOW500_ORIG;
RUN;

proc factor data=GLOW500 simple corr;
run;

ods graphics on;
proc princomp data=GLOW500 plots(ncomp=3)=all n=5;
run;

proc candisc data=GLOW500 out=discrim_out ; 
  class FRACTURE; 
  var SITE_ID	PHY_ID PRIORFRAC AGE WEIGHT HEIGHT BMI PREMENO MOMFRAC ARMASSIST SMOKE RATERISK FRACSCORE;
run;

	title 'Stepwise Regression on Global Longitudinal Study of Osteoporosis in Women (GLOW) Dataset';
	proc logistic data=GLOW500 outest=betas covout;
	model FRACTURE(event='1')=SITE_ID PHY_ID PRIORFRAC AGE WEIGHT HEIGHT BMI PREMENO	MOMFRAC	ARMASSIST	SMOKE	RATERISK	FRACSCORE
	                   / selection=stepwise;
	output out=pred p=phat lower=lcl upper=ucl predprob=(individual crossvalidate);
	run;

data train test;
set GLOW500;
if rand('uniform') <= 0.3
then output test;
else output train;
run;

ods graphics on;
proc logistic data=train;
model FRACTURE(event="1") = RATERISK FRACSCORE HEIGHT / outroc=troc;
score data=test out=valpred outroc=vroc;
roc; roccontrast;
run;

proc logistic data=train plots(only)=roc;
model FRACTURE(event="1") = RATERISK FRACSCORE HEIGHT;
run;

proc logistic data=train rocoptions(crossvalidate) plots(only)=roc;
model FRACTURE(event="1") = RATERISK FRACSCORE HEIGHT;
run;

proc discrim data=train testdata=test canonical;
class FRACTURE;
var SITE_ID	PHY_ID PRIORFRAC AGE WEIGHT HEIGHT BMI PREMENO MOMFRAC ARMASSIST SMOKE RATERISK FRACSCORE;
run;

proc hpforest data=train;
target FRACTURE/level=nominal;
input PRIORFRAC PREMENO MOMFRAC ARMASSIST SMOKE/level=nominal;
input SITE_ID PHY_ID AGE WEIGHT HEIGHT BMI RATERISK FRACSCORE/level=interval;
run;


```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```
